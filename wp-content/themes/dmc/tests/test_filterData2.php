<?php
/**
 * Тестовый скрипт для функции filterInsuranceData
 * 
 * Использование:
 * php test_filterInsuranceData.php
 * или через браузер: http://your-site.com/wp-content/themes/dmc/test_filterInsuranceData.php
 */

// Подключаем WordPress функции (если запускается через браузер)
if (file_exists('../../../wp-load.php')) {
    require_once('../../../wp-load.php');
} else {
    // Если запускается из командной строки, подключаем functions.php напрямую
    require_once(__DIR__ . '/functions.php');
}

// Проверяем, что функция существует
if (!function_exists('filterInsuranceData')) {
    die("Ошибка: функция filterInsuranceData не найдена. Убедитесь, что functions.php подключен.\n");
}

// ============================================
// МОК-ДАННЫЕ ДЛЯ ТЕСТИРОВАНИЯ
// ============================================

$mockData = [
    [
        'Город' => 'Москва',
        'Уровень' => 'Стандарт',
        'Кол-во_сотрудников' => '1-10',
        'Страховщик' => 'Сбербанк страхование',
        'Стоматология' => '5000',
        'Скорая_помощь' => '3000',
        'Госпитализация' => '10000',
        'Вызов_врача_на_дом' => '2000',
        'Поликлиника' => '15000'
    ],
    [
        'Город' => 'Москва',
        'Уровень' => 'Комфорт',
        'Кол-во_сотрудников' => '1-10',
        'Страховщик' => 'РГС',
        'Стоматология' => '8000',
        'Скорая_помощь' => '5000',
        'Госпитализация' => '15000',
        'Вызов_врача_на_дом' => '3000',
        'Поликлиника' => '20000'
    ],
    [
        'Город' => 'Санкт-Петербург',
        'Уровень' => 'Стандарт',
        'Кол-во_сотрудников' => '11-50',
        'Страховщик' => 'Ингос',
        'Стоматология' => '6000',
        'Скорая_помощь' => '3500',
        'Госпитализация' => '12000',
        'Вызов_врача_на_дом' => '2500',
        'Поликлиника' => '18000'
    ],
    [
        'Город' => 'Барнаул',
        'Уровень' => 'Комфорт',
        'Кол-во_сотрудников' => '1-10',
        'Страховщик' => 'АльфаСтрахование',
        'Стоматология' => '7000',
        'Скорая_помощь' => '4000',
        'Госпитализация' => '11000',
        'Вызов_врача_на_дом' => '2200',
        'Поликлиника' => '16000'
    ],
    [
        'Город' => 'Другой город',
        'Уровень' => 'Стандарт',
        'Кол-во_сотрудников' => '1-10',
        'Страховщик' => 'СОГАЗ',
        'Стоматология' => '4500',
        'Скорая_помощь' => '2800',
        'Госпитализация' => '9500',
        'Вызов_врача_на_дом' => '1800',
        'Поликлиника' => '14000'
    ],
    [
        'Город' => 'Другой город',
        'Уровень' => 'Комфорт',
        'Кол-во_сотрудников' => '11-50',
        'Страховщик' => 'Ренессанс',
        'Стоматология' => '9000',
        'Скорая_помощь' => '6000',
        'Госпитализация' => '18000',
        'Вызов_врача_на_дом' => '4000',
        'Поликлиника' => '25000'
    ],
    [
        'Город' => 'Архангельск',
        'Уровень' => 'Комфорт',
        'Кол-во_сотрудников' => '1-10',
        'Страховщик' => 'Т-страхование',
        'Стоматология' => '7500',
        'Скорая_помощь' => '4500',
        'Госпитализация' => '13000',
        'Вызов_врача_на_дом' => '2800',
        'Поликлиника' => '17000'
    ],
];

// ============================================
// ТЕСТОВЫЕ СЦЕНАРИИ
// ============================================

function printTestResult($testName, $result, $expected = null) {
    echo "\n" . str_repeat("=", 80) . "\n";
    echo "ТЕСТ: $testName\n";
    echo str_repeat("=", 80) . "\n";
    
    if ($expected !== null) {
        $passed = ($result === $expected);
        echo "Результат: " . ($passed ? "✅ ПРОЙДЕН" : "❌ ПРОВАЛЕН") . "\n";
        if (!$passed) {
            echo "Ожидалось:\n";
            print_r($expected);
            echo "Получено:\n";
        }
    }
    
    echo "Данные:\n";
    print_r($result);
    echo "\n";
}

// Тест 1: Фильтрация по одному городу
echo "\n\n";
echo "╔══════════════════════════════════════════════════════════════════════════════╗\n";
echo "║                    ТЕСТИРОВАНИЕ ФУНКЦИИ filterInsuranceData                         ║\n";
echo "╚══════════════════════════════════════════════════════════════════════════════╝\n";

// Тест 1: Фильтрация по одному городу
$result1 = filterInsuranceData($mockData, ['Москва']);
printTestResult("Тест 1: Фильтрация по городу 'Москва'", $result1);
assert(isset($result1['Москва']), "Должен быть найден город Москва");
assert(count($result1['Москва']) === 2, "Должно быть 2 записи для Москвы");

// Тест 2: Фильтрация по нескольким городам
$result2 = filterInsuranceData($mockData, ['Москва', 'Барнаул', 'Архангельск']);
printTestResult("Тест 2: Фильтрация по нескольким городам", $result2);
assert(isset($result2['Москва']), "Должен быть найден город Москва");
assert(isset($result2['Барнаул']), "Должен быть найден город Барнаул");
assert(isset($result2['Архангельск']), "Должен быть найден город Архангельск");

// Тест 3: Фильтрация по уровню
$result3 = filterInsuranceData($mockData, [], ['Комфорт']);
printTestResult("Тест 3: Фильтрация по уровню 'Комфорт'", $result3);
foreach ($result3 as $city => $rows) {
    foreach ($rows as $row) {
        assert($row['Уровень'] === 'Комфорт', "Все записи должны иметь уровень 'Комфорт'");
    }
}

// Тест 4: Фильтрация по количеству сотрудников
$result4 = filterInsuranceData($mockData, [], [], 5);
printTestResult("Тест 4: Фильтрация по количеству сотрудников (5 человек, диапазон 1-10)", $result4);
foreach ($result4 as $city => $rows) {
    foreach ($rows as $row) {
        assert($row['Кол-во_сотрудников'] === '1-10', "Все записи должны быть в диапазоне 1-10");
    }
}

// Тест 5: Комбинированная фильтрация (город + уровень + количество)
$result5 = filterInsuranceData($mockData, ['Москва'], ['Комфорт'], 5);
printTestResult("Тест 5: Комбинированная фильтрация (Москва, Комфорт, 5 сотрудников)", $result5);
assert(isset($result5['Москва']), "Должен быть найден город Москва");
assert(count($result5['Москва']) === 1, "Должна быть 1 запись для Москвы с уровнем Комфорт");
assert($result5['Москва'][0]['Уровень'] === 'Комфорт', "Уровень должен быть 'Комфорт'");

// Тест 6: Фильтрация по несуществующему городу (fallback на "Другой город")
$result6 = filterInsuranceData($mockData, ['НесуществующийГород'], ['Стандарт'], 5);
printTestResult("Тест 6: Фильтрация по несуществующему городу (fallback на 'Другой город')", $result6);
if (isset($result6['Другой город'])) {
    echo "✅ Fallback сработал: найдены записи для 'Другой город'\n";
} else {
    echo "⚠️ Fallback не сработал или нет подходящих записей\n";
}

// Тест 7: Фильтрация по городу как строке (не массив)
$result7 = filterInsuranceData($mockData, 'Москва');
printTestResult("Тест 7: Фильтрация по городу как строке (не массив)", $result7);
assert(isset($result7['Москва']), "Должен работать с строковым параметром");

// Тест 8: Пустые параметры (должны вернуть все данные)
$result8 = filterInsuranceData($mockData);
printTestResult("Тест 8: Без фильтров (должны вернуться все данные)", $result8);
$totalRows = 0;
foreach ($result8 as $rows) {
    $totalRows += count($rows);
}
assert($totalRows === count($mockData), "Должны вернуться все записи");

// Тест 9: Проверка порядка городов
$result9 = filterInsuranceData($mockData, ['Архангельск', 'Барнаул', 'Москва']);
printTestResult("Тест 9: Проверка сохранения порядка городов", $result9);
$citiesOrder = array_keys($result9);
$expectedOrder = ['Архангельск', 'Барнаул', 'Москва'];
$actualOrder = array_intersect($expectedOrder, $citiesOrder);
echo "Порядок городов: " . implode(', ', array_keys($result9)) . "\n";

// Тест 10: Фильтрация по количеству сотрудников вне диапазона
$result10 = filterInsuranceData($mockData, [], [], 100);
printTestResult("Тест 10: Фильтрация по количеству сотрудников (100, вне всех диапазонов)", $result10);
$totalRows10 = 0;
foreach ($result10 as $rows) {
    $totalRows10 += count($rows);
}
echo "Найдено записей: $totalRows10 (ожидается 0 или записи без фильтра по количеству)\n";

// Тест 11: Фильтрация с пробелами в параметрах
$result11 = filterInsuranceData($mockData, [' Москва ', '  Барнаул  '], [' Комфорт ']);
printTestResult("Тест 11: Фильтрация с пробелами в параметрах (должны быть обрезаны)", $result11);
assert(isset($result11['Москва']) || isset($result11['Барнаул']), "Пробелы должны быть обрезаны");

// Тест 12: Пустые строки в массивах
$result12 = filterInsuranceData($mockData, ['Москва', '', '  ', 'Барнаул'], ['Комфорт', '']);
printTestResult("Тест 12: Фильтрация с пустыми строками в массивах", $result12);

echo "\n\n";
echo "╔══════════════════════════════════════════════════════════════════════════════╗\n";
echo "║                         ТЕСТИРОВАНИЕ ЗАВЕРШЕНО                               ║\n";
echo "╚══════════════════════════════════════════════════════════════════════════════╝\n";
echo "\n";

