<?php
/**
 * Тестовый скрипт для функции calculate_total_price
 * 
 * Использование:
 * php test_calculate_total_price.php
 * или через браузер: http://your-site.com/wp-content/themes/dmc/tests/test_calculate_total_price.php
 */

// Подключаем WordPress функции (если запускается через браузер)
if (file_exists('../../../wp-load.php')) {
    require_once('../../../wp-load.php');
} else {
    // Если запускается из командной строки, подключаем functions.php напрямую
    require_once(__DIR__ . '/../functions.php');
}

// Проверяем, что функция существует
if (!function_exists('calculate_total_price')) {
    die("Ошибка: функция calculate_total_price не найдена. Убедитесь, что functions.php подключен.\n");
}

// ============================================
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
// ============================================

function printTestResult($testName, $result, $expected = null, $tolerance = 0.01) {
    echo "\n" . str_repeat("=", 80) . "\n";
    echo "ТЕСТ: $testName\n";
    echo str_repeat("=", 80) . "\n";
    
    if ($expected !== null) {
        $passed = abs($result - $expected) < $tolerance;
        echo "Ожидалось: " . number_format($expected, 2, '.', ' ') . "\n";
        echo "Получено:  " . number_format($result, 2, '.', ' ') . "\n";
        echo "Результат: " . ($passed ? "✅ ПРОЙДЕН" : "❌ ПРОВАЛЕН") . "\n";
        if (!$passed) {
            echo "Разница: " . abs($result - $expected) . "\n";
        }
    } else {
        echo "Результат: " . number_format($result, 2, '.', ' ') . "\n";
    }
    echo "\n";
}

// ============================================
// ТЕСТОВЫЕ СЦЕНАРИИ
// ============================================

echo "\n\n";
echo "╔══════════════════════════════════════════════════════════════════════════════╗\n";
echo "║              ТЕСТИРОВАНИЕ ФУНКЦИИ calculate_total_price                     ║\n";
echo "╚══════════════════════════════════════════════════════════════════════════════╝\n";

// Тест 1: Базовое суммирование без пробелов
$row1 = [
    'Стоматология' => '5000',
    'Скорая_помощь' => '3000',
    'Госпитализация' => '10000',
    'Вызов_врача_на_дом' => '2000',
    'Поликлиника' => '15000'
];
$result1 = calculate_total_price($row1);
$expected1 = 5000 + 3000 + 10000 + 2000 + 15000; // 35000
printTestResult("Тест 1: Базовое суммирование без пробелов", $result1, $expected1);
assert(abs($result1 - $expected1) < 0.01, "Тест 1 провален");

// Тест 2: Суммирование с пробелами в значениях
$row2 = [
    'Стоматология' => '5 000',
    'Скорая_помощь' => '3 000',
    'Госпитализация' => '10 000',
    'Вызов_врача_на_дом' => '2 000',
    'Поликлиника' => '15 000'
];
$result2 = calculate_total_price($row2);
$expected2 = 5000 + 3000 + 10000 + 2000 + 15000; // 35000
printTestResult("Тест 2: Суммирование с пробелами в значениях", $result2, $expected2);
assert(abs($result2 - $expected2) < 0.01, "Тест 2 провален");

// Тест 3: Суммирование с запятыми вместо точек
$row3 = [
    'Стоматология' => '5000,50',
    'Скорая_помощь' => '3000,25',
    'Госпитализация' => '10000,75',
    'Вызов_врача_на_дом' => '2000,10',
    'Поликлиника' => '15000,40'
];
$result3 = calculate_total_price($row3);
$expected3 = 5000.50 + 3000.25 + 10000.75 + 2000.10 + 15000.40; // 35002.0
printTestResult("Тест 3: Суммирование с запятыми вместо точек", $result3, $expected3);
assert(abs($result3 - $expected3) < 0.01, "Тест 3 провален");

// Тест 4: Суммирование с пробелами и запятыми
$row4 = [
    'Стоматология' => '5 000,50',
    'Скорая_помощь' => '3 000,25',
    'Госпитализация' => '10 000,75',
    'Вызов_врача_на_дом' => '2 000,10',
    'Поликлиника' => '15 000,40'
];
$result4 = calculate_total_price($row4);
$expected4 = 5000.50 + 3000.25 + 10000.75 + 2000.10 + 15000.40; // 35002.0
printTestResult("Тест 4: Суммирование с пробелами и запятыми", $result4, $expected4);
assert(abs($result4 - $expected4) < 0.01, "Тест 4 провален");

// Тест 5: Смешанные форматы (с пробелами и без)
$row5 = [
    'Стоматология' => '5000',
    'Скорая_помощь' => '3 000',
    'Госпитализация' => '10000,50',
    'Вызов_врача_на_дом' => '2 000,25',
    'Поликлиника' => '15000'
];
$result5 = calculate_total_price($row5);
$expected5 = 5000 + 3000 + 10000.50 + 2000.25 + 15000; // 35000.75
printTestResult("Тест 5: Смешанные форматы (с пробелами и без)", $result5, $expected5);
assert(abs($result5 - $expected5) < 0.01, "Тест 5 провален");

// Тест 6: Пустые значения игнорируются
$row6 = [
    'Стоматология' => '5000',
    'Скорая_помощь' => '',
    'Госпитализация' => '10000',
    'Вызов_врача_на_дом' => '',
    'Поликлиника' => '15000'
];
$result6 = calculate_total_price($row6);
$expected6 = 5000 + 10000 + 15000; // 30000
printTestResult("Тест 6: Пустые значения игнорируются", $result6, $expected6);
assert(abs($result6 - $expected6) < 0.01, "Тест 6 провален");

// Тест 7: Нулевые значения игнорируются
$row7 = [
    'Стоматология' => '5000',
    'Скорая_помощь' => '0',
    'Госпитализация' => '10000',
    'Вызов_врача_на_дом' => '0',
    'Поликлиника' => '15000'
];
$result7 = calculate_total_price($row7);
$expected7 = 5000 + 10000 + 15000; // 30000
printTestResult("Тест 7: Нулевые значения игнорируются", $result7, $expected7);
assert(abs($result7 - $expected7) < 0.01, "Тест 7 провален");

// Тест 8: Нечисловые значения игнорируются
$row8 = [
    'Стоматология' => '5000',
    'Скорая_помощь' => 'abc',
    'Госпитализация' => '10000',
    'Вызов_врача_на_дом' => '#Н/Д',
    'Поликлиника' => '15000'
];
$result8 = calculate_total_price($row8);
$expected8 = 5000 + 10000 + 15000; // 30000
printTestResult("Тест 8: Нечисловые значения игнорируются", $result8, $expected8);
assert(abs($result8 - $expected8) < 0.01, "Тест 8 провален");

// Тест 9: Большие числа с пробелами
$row9 = [
    'Стоматология' => '50 000',
    'Скорая_помощь' => '30 000',
    'Госпитализация' => '100 000',
    'Вызов_врача_на_дом' => '20 000',
    'Поликлиника' => '150 000'
];
$result9 = calculate_total_price($row9);
$expected9 = 50000 + 30000 + 100000 + 20000 + 150000; // 350000
printTestResult("Тест 9: Большие числа с пробелами", $result9, $expected9);
assert(abs($result9 - $expected9) < 0.01, "Тест 9 провален");

// Тест 10: Все поля пустые
$row10 = [
    'Стоматология' => '',
    'Скорая_помощь' => '',
    'Госпитализация' => '',
    'Вызов_врача_на_дом' => '',
    'Поликлиника' => ''
];
$result10 = calculate_total_price($row10);
printTestResult("Тест 10: Все поля пустые", $result10, 0);
assert($result10 == 0, "Тест 10 провален");

// Тест 11: Один валидный элемент
$row11 = [
    'Стоматология' => '5000',
    'Скорая_помощь' => '',
    'Госпитализация' => '',
    'Вызов_врача_на_дом' => '',
    'Поликлиника' => ''
];
$result11 = calculate_total_price($row11);
printTestResult("Тест 11: Один валидный элемент", $result11, 5000);
assert($result11 == 5000, "Тест 11 провален");

// Тест 12: Значения с множественными пробелами
$row12 = [
    'Стоматология' => '5   000',
    'Скорая_помощь' => '3  000',
    'Госпитализация' => '10   000',
    'Вызов_врача_на_дом' => '2 000',
    'Поликлиника' => '15 000'
];
$result12 = calculate_total_price($row12);
$expected12 = 5000 + 3000 + 10000 + 2000 + 15000; // 35000
printTestResult("Тест 12: Значения с множественными пробелами", $result12, $expected12);
assert(abs($result12 - $expected12) < 0.01, "Тест 12 провален");

// Тест 13: Отсутствующие поля
$row13 = [
    'Стоматология' => '5000',
    'Госпитализация' => '10000',
    'Поликлиника' => '15000'
    // Скорая_помощь и Вызов_врача_на_дом отсутствуют
];
$result13 = calculate_total_price($row13);
$expected13 = 5000 + 10000 + 15000; // 30000
printTestResult("Тест 13: Отсутствующие поля игнорируются", $result13, $expected13);
assert(abs($result13 - $expected13) < 0.01, "Тест 13 провален");

echo "\n\n";
echo "╔══════════════════════════════════════════════════════════════════════════════╗\n";
echo "║                         ТЕСТИРОВАНИЕ ЗАВЕРШЕНО                               ║\n";
echo "╚══════════════════════════════════════════════════════════════════════════════╝\n";
echo "\n";
echo "Все тесты пройдены успешно! ✅\n";
echo "\n";

