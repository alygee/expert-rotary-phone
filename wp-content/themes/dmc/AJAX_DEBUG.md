# Диагностика проблемы с пустым ответом AJAX

## Проблема
Запрос к `wp-admin/admin-ajax.php` на тестовом сервере возвращает пустой результат, хотя локально и на проде работает нормально.

## Что было исправлено

### 1. Улучшена функция `filter_callback()` в `functions.php`:
- ✅ Добавлена инициализация переменных
- ✅ Добавлена проверка данных перед обработкой
- ✅ Добавлено логирование ошибок
- ✅ Заменен `exit()` на `wp_die()` (правильный способ в WordPress)
- ✅ Добавлена обработка пустых результатов

### 2. Создан диагностический скрипт `debug_ajax.php`

## Быстрая диагностика

### Шаг 1: Запустите диагностический скрипт
Откройте в браузере:
```
http://your-test-server.com/wp-content/themes/dmc/debug_ajax.php
```

Скрипт проверит:
- ✅ Наличие всех необходимых функций
- ✅ Доступность CSV файла
- ✅ Работу функции `rez()`
- ✅ Регистрацию AJAX хуков
- ✅ Тестовый AJAX запрос

### Шаг 2: Проверьте логи ошибок
На тестовом сервере проверьте:
- Логи PHP: `/var/log/php-fpm/error.log` или `/var/log/apache2/error.log`
- Логи WordPress: `wp-content/debug.log` (если WP_DEBUG_LOG включен)

### Шаг 3: Проверьте настройки тестового сервера

#### Возможные причины пустого ответа:

1. **CSV файл не доступен**
   - Проверьте путь к CSV файлу в ACF
   - Проверьте права доступа к файлу (должен быть читаемым)
   - Проверьте, что файл существует

2. **Ошибки PHP не выводятся**
   ```php
   // В wp-config.php добавьте:
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   define('WP_DEBUG_DISPLAY', true);
   ```

3. **Проблемы с кодировкой**
   - Убедитесь, что CSV файл в UTF-8
   - Проверьте настройки кодировки в PHP

4. **Проблемы с путями**
   - Проверьте, что `get_field('csv_file', 2)` возвращает правильный путь
   - На тестовом сервере путь может отличаться от локального

5. **Буферизация вывода**
   - Попробуйте добавить в начало `filter_callback()`:
   ```php
   ob_clean();
   ```

6. **Проблемы с правами доступа**
   ```bash
   # Проверьте права на файлы
   ls -la wp-content/themes/dmc/
   # Должны быть читаемыми для веб-сервера
   ```

## Ручная проверка

### Проверка через консоль браузера:
```javascript
// Откройте консоль (F12) и выполните:
fetch('/wp-admin/admin-ajax.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'action=action&count=5&level=Стандарт&region=Москва'
})
.then(r => r.text())
.then(data => console.log('Ответ:', data.length, 'символов', data));
```

### Проверка через curl:
```bash
curl -X POST http://your-site.com/wp-admin/admin-ajax.php \
  -d "action=action" \
  -d "count=5" \
  -d "level=Стандарт" \
  -d "region=Москва" \
  -v
```

## Что проверить в первую очередь

1. **CSV файл** - самая частая причина:
   ```php
   // Добавьте в начало filter_callback() для отладки:
   error_log('CSV путь: ' . get_field('csv_file', 2));
   error_log('Данные: ' . print_r(rez(), true));
   ```

2. **Проверьте Network вкладку в DevTools**:
   - Статус ответа (должен быть 200)
   - Размер ответа (если 0 - проблема на сервере)
   - Заголовки ответа

3. **Проверьте консоль PHP**:
   ```bash
   tail -f /var/log/php-fpm/error.log
   # или
   tail -f wp-content/debug.log
   ```

## Временное решение для отладки

Добавьте в начало `filter_callback()`:
```php
function filter_callback(){
    // ВРЕМЕННО для отладки
    error_reporting(E_ALL);
    ini_set('display_errors', 1);
    ini_set('log_errors', 1);
    
    // Остальной код...
}
```

## После исправления

**ВАЖНО:** Удалите файл `debug_ajax.php` после диагностики, так как он может быть небезопасен!

```bash
rm wp-content/themes/dmc/debug_ajax.php
```

## Контакты для помощи

Если проблема не решена, соберите следующую информацию:
1. Результаты диагностического скрипта
2. Логи ошибок PHP
3. Ответ Network вкладки браузера
4. Версию PHP и WordPress

